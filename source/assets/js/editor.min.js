/* globals Editor:true, Leafpub */
/* jshint unused:false */
//
// We're trying to completely abstract TinyMCE so it could be replaced with another library or maybe
// even a plugin somewhere down the road.
//
var Editor;!function(){"use strict";function t(t,e){switch(e){case"test":return this.formatter.match(t);case"apply":this.formatter.apply(t),this.nodeChanged();break;case"remove":this.formatter.remove(t),this.nodeChanged();break;default:this.formatter.toggle(t),this.nodeChanged()}}Editor=function(t,e){function n(t){"focus"===t.type?this.getContent()===a.options.placeholder&&this.execCommand("selectAll",!1,null):$.trim(this.getContent()).length||this.setContent(a.options.placeholder)}function r(t){13===t.keyCode&&t.preventDefault()}function o(t){var e,n,r,o=new DOMParser,i=o.parseFromString(t,"text/html"),a=i.body.querySelectorAll("*");for(n=0;n<a.length;n++)for(e=a[n].attributes,r=0;r<e.length;r++)e[r].name.match(/^data-mce-/)&&a[n].removeAttribute(e[r].name);return i.body.innerHTML}var i,a=this,l=t.ownerDocument,d=l.defaultView,s=d.tinymce;a.element=t,a.options=$.extend({},{allowNewlines:!0,placeholder:!1,textOnly:!1},e),i={browser_spellcheck:!0,document_base_url:Leafpub.url().replace(/\/$/,"")+"/",element_format:"html",entity_encoding:"raw",extended_valid_elements:"i[class],iframe[*],script[*]",formats:{alignleft:[{selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img",classes:"align-left"},{selector:"[data-embed]",classes:"align-left",ceFalseOverride:!0}],aligncenter:[{selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img",classes:"align-center"},{selector:"[data-embed]",classes:"align-center",ceFalseOverride:!0}],alignright:[{selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img",classes:"align-right"},{selector:"[data-embed]",classes:"align-right",ceFalseOverride:!0}],alignjustify:[{selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table",classes:"align-justify"}],div:{},strikethrough:{inline:"del"},underline:{inline:"u"}},hidden_input:!1,inline:!0,menubar:!1,object_resizing:!1,plugins:"lists,paste,table,textpattern",relative_urls:!0,selector:'[data-leafpub-id="'+t.getAttribute("data-leafpub-id")+'"]',skin:!1,textpattern_patterns:[{start:"*",end:"*",format:"italic"},{start:"_",end:"_",format:"italic"},{start:"**",end:"**",format:"bold"},{start:"__",end:"__",format:"bold"},{start:"~~",end:"~~",format:"strikethrough"},{start:"`",end:"`",format:"code"},{start:"#",format:"h1"},{start:"##",format:"h2"},{start:"###",format:"h3"},{start:"####",format:"h4"},{start:"#####",format:"h5"},{start:"######",format:"h6"},{start:"> ",format:"blockquote"},{start:"1. ",cmd:"InsertOrderedList"},{start:"1) ",cmd:"InsertOrderedList"},{start:"* ",cmd:"InsertUnorderedList"},{start:"- ",cmd:"InsertUnorderedList"}],toolbar:!1,setup:function(t){a.editor=t,a.editor.on("PreInit",function(){a.editor.windowManager={alert:function(){},close:function(){},confirm:function(){},getParams:function(){},open:function(){},setParams:function(){}}}),a.editor.on("BeforeSetContent",function(t){var e,n=new DOMParser,r=n.parseFromString(t.content,"text/html"),i=r.body.querySelectorAll("[data-embed]");for(e=0;e<i.length;e++)i[e].setAttribute("data-embed",o(i[e].innerHTML)),i[e].setAttribute("contenteditable",!1);t.content=r.body.innerHTML}),a.editor.on("GetContent",function(t){var e,n=new DOMParser,r=n.parseFromString(t.content,"text/html"),o=r.body.querySelectorAll("[data-embed]");for(e=0;e<o.length;e++)o[e].removeAttribute("contenteditable"),o[e].innerHTML=o[e].getAttribute("data-embed"),o[e].setAttribute("data-embed",!0);t.content=r.body.innerHTML}),a.options.allowNewlines||a.editor.on("keydown",r),a.options.placeholder&&a.editor.on("focus blur",function(t){n.call(a.editor,t)}),a.options.nodeChange&&a.editor.on("NodeChange",function(){a.options.nodeChange.call(a)}),a.options.focus&&a.editor.on("focus",function(){a.options.focus.call(a)}),a.options.blur&&a.editor.on("blur",function(){a.options.blur.call(a)}),a.options.change&&a.editor.on("change",function(){a.options.change.call(a)}),a.options.click&&a.editor.on("click",function(t){a.options.click.call(a,t)}),a.options.dblclick&&a.editor.on("dblclick",function(t){a.options.dblclick.call(a,t)}),a.options.keydown&&a.editor.getElement().addEventListener("keydown",function(t){a.options.keydown.call(a,t)},!1),a.options.keyup&&a.editor.getElement().addEventListener("keyup",function(t){a.options.keyup.call(a,t)},!1),a.options.paste&&a.editor.on("paste",function(t){a.options.paste.call(a,t)})},init_instance_callback:function(){a.cleanState=a.editor.getContent(),a.options.ready&&a.options.ready.call(a)}},a.options.textOnly&&(i=$.extend({},i,{forced_root_block:!1,formats:{h1:{},h2:{},h3:{},h4:{},h5:{},h6:{},pre:{},div:{},p:{},blockquote:{},bold:{},italic:{},underline:{},code:{},strikethrough:{},subscript:{},superscript:{},alignleft:{},alignright:{},aligncenter:{},alignjustify:{}},valid_elements:"br"})),s.init(i)},Editor.prototype={disable:function(t){this.editor.setMode(t===!1?"design":"readonly")},focus:function(){this.editor.focus()},getBookmark:function(){return this.editor.selection.getBookmark(2)},getContent:function(t){return this.options.textOnly?this.editor.getBody().textContent:this.editor.getContent()},getElement:function(){return this.element},getSelectedElement:function(){return this.editor.selection.getNode()},insertContent:function(t){this.editor.execCommand("mceInsertContent",!1,t)},isDirty:function(t){return t?void(this.cleanState=this.editor.getContent()):this.cleanState!==this.editor.getContent()},restoreBookmark:function(t){this.editor.selection.moveToBookmark(t)},setContent:function(t){this.editor.setContent(t)},setSelectedElement:function(t){this.editor.selection.select(t)},blockquote:function(e){return t.call(this.editor,"blockquote",e)},bold:function(e){return t.call(this.editor,"bold",e)},code:function(e){return t.call(this.editor,"code",e)},heading1:function(e){return t.call(this.editor,"h1",e)},heading2:function(e){return t.call(this.editor,"h2",e)},heading3:function(e){return t.call(this.editor,"h3",e)},heading4:function(e){return t.call(this.editor,"h4",e)},heading5:function(e){return t.call(this.editor,"h5",e)},heading6:function(e){return t.call(this.editor,"h6",e)},italic:function(e){return t.call(this.editor,"italic",e)},paragraph:function(e){return t.call(this.editor,"p",e)},preformatted:function(e){return t.call(this.editor,"pre",e)},strikethrough:function(e){return t.call(this.editor,"strikethrough",e)},subscript:function(e){return t.call(this.editor,"subscript",e)},superscript:function(e){return t.call(this.editor,"superscript",e)},underline:function(e){return t.call(this.editor,"underline",e)},alignCenter:function(t){return"test"===t?this.editor.formatter.match("aligncenter"):void this.editor.execCommand("JustifyCenter")},alignJustify:function(t){return"test"===t?this.editor.formatter.match("alignjustify"):void this.editor.execCommand("JustifyFull")},alignLeft:function(t){return"test"===t?this.editor.formatter.match("alignleft"):void this.editor.execCommand("JustifyLeft")},alignRight:function(t){return"test"===t?this.editor.formatter.match("alignright"):void this.editor.execCommand("JustifyRight")},clearUndos:function(){this.editor.undoManager.clear()},embed:function(t,e){var n,r=this.editor,o=r.dom.getParent(r.selection.getNode(),"[data-embed]");return e=e||{},"test"===t?!!o:void("insert"===t?o?r.undoManager.transact(function(){o.setAttribute("data-embed",e.code),o.setAttribute("contenteditable",!1),o.innerHTML=e.code,r.formatter.remove("alignleft"),r.formatter.remove("aligncenter"),r.formatter.remove("alignright"),r.formatter.remove("alignjustify"),"left"===e.align&&r.formatter.apply("alignleft"),"center"===e.align&&r.formatter.apply("aligncenter"),"right"===e.align&&r.formatter.apply("alignright")}):r.undoManager.transact(function(){n=document.createElement("div"),n.setAttribute("data-embed",e.code),n.setAttribute("contenteditable",!1),n.innerHTML=e.code,r.insertContent(n.outerHTML),"left"===e.align&&r.formatter.apply("alignleft"),"center"===e.align&&r.formatter.apply("aligncenter"),"right"===e.align&&r.formatter.apply("alignright")}):"remove"===t&&(r.dom.remove(o),r.undoManager.add()))},image:function(t,e){var n=this.editor,r=n.dom.getParent(n.selection.getNode(),"img"),o=n.dom.getParent(n.selection.getNode(),"a");return e=e||{},"test"===t?!!r:void("insert"===t?r?n.undoManager.transact(function(){n.dom.setAttribs(r,{src:e.src||"",alt:e.alt||"",width:e.width||null,height:e.height||null}),n.formatter.remove("alignleft"),n.formatter.remove("aligncenter"),n.formatter.remove("alignright"),n.formatter.remove("alignjustify"),"left"===e.align&&n.formatter.apply("alignleft"),"center"===e.align&&n.formatter.apply("aligncenter"),"right"===e.align&&n.formatter.apply("alignright"),e.href?(o?n.dom.setAttribs(o,{href:e.href}):n.dom.replace(n.dom.create("a",{href:e.href},r.outerHTML),r),n.undoManager.add()):o&&(n.dom.replace(r,o),n.undoManager.add(),n.nodeChanged())}):n.undoManager.transact(function(){r=n.dom.create("img",{src:e.src||"",alt:e.alt||"",width:e.width||null,height:e.height||null}),e.href&&(r=n.dom.create("a",{href:e.href},r.outerHTML)),n.insertContent(r.outerHTML),"left"===e.align&&n.formatter.apply("alignleft"),"center"===e.align&&n.formatter.apply("aligncenter"),"right"===e.align&&n.formatter.apply("alignright")}):"remove"===t&&(n.dom.remove(r),n.undoManager.add()))},indent:function(){this.editor.execCommand("indent")},link:function(t,e){var n=this.editor;return e=e||{},"test"===t?!!n.dom.getParent(n.selection.getNode(),"a"):void("insert"===t?n.execCommand("mceInsertLink",!1,{href:e.href||"",target:e.target||"",title:e.title||"","class":e["class"]||"",rel:e.target?"noopener":""}):"remove"===t&&n.execCommand("unlink"))},orderedList:function(t){return"test"===t?!!this.editor.dom.getParent(this.editor.selection.getNode(),"ol"):void this.editor.execCommand("InsertOrderedList")},outdent:function(){this.editor.execCommand("outdent")},redo:function(t){return"test"===t?this.editor.undoManager.hasRedo():void this.editor.execCommand("Redo")},removeFormat:function(){this.editor.execCommand("RemoveFormat")},undo:function(t){return"test"===t?this.editor.undoManager.hasUndo():void this.editor.execCommand("Undo")},unorderedList:function(t){return"test"===t?!!this.editor.dom.getParent(this.editor.selection.getNode(),"ul"):void this.editor.execCommand("InsertUnorderedList")}}}();