/* globals Cookies, Editor, Nanobar, Leafpub */
$(function(){"use strict";function e(){C=setTimeout(function(){$(".drop-post-image, .drop-content-image").removeClass("active"),$(".dropzone").prop("hidden",!0)},10)}function t(e){var t=$("#tags").get(0).selectize;v.setContent(e.title),b.setContent(e.content),v.clearUndos(),b.clearUndos(),$("#slug").val(e.slug),$("#pub-date").val(e.pub_date),$("#pub-time").val(e.pub_time),$("#image").val(e.image),$("#author").val(e.author),$("#status").val(e.status),$("#featured").prop("checked",1===parseInt(e.featured)),$("#sticky").prop("checked",1===parseInt(e.sticky)),$("#page").prop("checked",1===parseInt(e.page)),$("#meta-title").val(e.meta_title),$("#meta-description").val(e.meta_description),t.setValue(e.tags),u(e.image),f(),h(),r(g()),k=JSON.stringify(g())}function a(e){n(),$(e).trigger("show.leafpub.panel"),$(e).on("transitionend.leafpub.panel",function(){$(e).off("transitionend.leafpub.panel").trigger("shown.leafpub.panel")}).addClass("active"),$(document).on("touchstart.leafpub.panel keydown.leafpub.panel mousedown.leafpub.panel",function(t){$(t.target).parents().addBack().is(e)||t.metaKey||t.cmdKey||t.shiftKey||n(e)}).on("keydown.leafpub.panel",function(t){27===t.keyCode&&(t.preventDefault(),n(e))}),$(e).find("form").on("submit.leafpub.panel",function(t){t.preventDefault(),n(e)}),$(e).find('[data-panel="hide"]').on("click.leafpub.panel",function(t){t.preventDefault(),n(e)})}function n(e){return e||(e=".panel.active"),!$(".alertable:visible").length&&($(e).find('[data-panel="hide"]').off(".leafpub.panel"),$(document).off(".leafpub.panel"),$(e).trigger("hide.leafpub.panel"),void $(e).on("transitionend.leafpub.panel",function(){$(e).off("transitionend.leafpub.panel").trigger("hidden.leafpub.panel")}).removeClass("active"))}function i(e){return void 0!==e.originalEvent&&(void 0!==e.originalEvent.dataTransfer&&$.inArray("Files",e.originalEvent.dataTransfer.types)>-1)}function o(){m=$(".editor-frame").get(0).contentWindow.document,$("html",m).addClass("leafpub"),$(".editor-loader").prop("hidden",!0),$(".editor-frame").prop("hidden",!1),$("html",m).is("[data-leafpub-error]")||($(".editor-toolbar").prop("hidden",!1),$(window).trigger("resize.leafpub"),$(m).on("click mousedown","a, area",function(e){$(this).parents().addBack().is("[data-leafpub-id]")||e.preventDefault()}),$(m).on("submit","form",function(e){e.preventDefault()}),$(m).on("click keydown mousedown touchstart",function(e){$(document).trigger(e)}),new Editor($('[data-leafpub-id="post:title"]',m).get(0),{allowNewlines:!1,placeholder:$(".editor-frame").attr("data-default-title"),textOnly:!0,ready:function(){v=this,v.focus(),l()}}),new Editor($('[data-leafpub-id="post:content"]',m).get(0),{placeholder:$(".editor-frame").attr("data-default-content"),nodeChange:function(){$('[data-editor="alignCenter"]').toggleClass("on",this.alignCenter("test")),$('[data-editor="alignJustify"]').toggleClass("on",this.alignJustify("test")),$('[data-editor="alignLeft"]').toggleClass("on",this.alignLeft("test")),$('[data-editor="alignRight"]').toggleClass("on",this.alignRight("test")),$('[data-editor="blockquote"]').toggleClass("on",this.blockquote("test")),$('[data-editor="bold"]').toggleClass("on",this.bold("test")),$('[data-editor="code"]').toggleClass("on",this.code("test")),$('[data-editor="embed"]').toggleClass("on",this.embed("test")),$('[data-editor="heading1"]').toggleClass("on",this.heading1("test")),$('[data-editor="heading2"]').toggleClass("on",this.heading2("test")),$('[data-editor="heading3"]').toggleClass("on",this.heading3("test")),$('[data-editor="heading4"]').toggleClass("on",this.heading4("test")),$('[data-editor="heading5"]').toggleClass("on",this.heading5("test")),$('[data-editor="heading6"]').toggleClass("on",this.heading6("test")),$('[data-editor="image"]').toggleClass("on",this.image("test")),$('[data-editor="italic"]').toggleClass("on",this.italic("test")),$('[data-editor="link"]').toggleClass("on",this.link("test")),$('[data-editor="orderedList"]').toggleClass("on",this.orderedList("test")),$('[data-editor="paragraph"]').toggleClass("on",this.paragraph("test")),$('[data-editor="preformatted"]').toggleClass("on",this.preformatted("test")),$('[data-editor="redo"]').prop("disabled",!this.redo("test")),$('[data-editor="strikethrough"]').toggleClass("on",this.strikethrough("test")),$('[data-editor="subscript"]').toggleClass("on",this.subscript("test")),$('[data-editor="superscript"]').toggleClass("on",this.superscript("test")),$('[data-editor="underline"]').toggleClass("on",this.underline("test")),$('[data-editor="undo"]').prop("disabled",!this.undo("test")),$('[data-editor="unorderedList"]').toggleClass("on",this.unorderedList("test")),$(".dropdown-menu").each(function(){var e=$(this),t=$(e).closest(".dropdown-btn");$(t).toggleClass("on",$(e).find(".on").length>0)})},dblclick:function(e){$(e.target).is("img")&&a(".image-panel"),$(e.target).is("[data-embed]")&&a(".embed-panel")},paste:function(e){var t=e.clipboardData||window.clipboardData,a=t.getData("Text");a.match(/^https?:\/\//i)&&(e.stopPropagation(),e.preventDefault(),E.go(50),$.ajax({url:Leafpub.url("api/oembed"),type:"GET",data:{url:a}}).done(function(e){e.code?b.embed("insert",{code:e.code}):b.insertContent(a)}).always(function(){E.go(100)}))},ready:function(){b=this,l()}}))}function l(){v&&b&&(D=!0,k=JSON.stringify(g()),$(document).add(m).on("dragover",function(e){e.preventDefault(),i(e)&&p(e)}).on("dragleave",function(t){t.preventDefault(),e()}).on("drop",function(t){var a=$(t.target).closest(".dropzone-target").attr("data-target");t.preventDefault(),e(),a&&i(t)&&Leafpub.upload({accept:"post-image"===a?"image":null,files:t.originalEvent.dataTransfer.files,progress:function(e){E.go(e)}}).then(function(e){e.uploaded.length&&("post-image"===a&&u(e.uploaded[0].relative_path),"content"===a&&(e.uploaded[0].filename.match(/\.(gif|jpg|jpeg|png|svg)$/i)?b.image("insert",{src:e.uploaded[0].relative_path,alt:e.uploaded[0].filename,width:e.uploaded[0].width,height:e.uploaded[0].height}):b.insertContent($("<a>").attr("href",e.uploaded[0].relative_path).text(e.uploaded[0].filename).get(0).outerHTML))),e.failed.length&&$.alertable.alert(e.failed[0].message)})}))}function r(e){var t=$.Deferred(),a=v.getElement(),n=b.getElement(),i=$("<form>");return E.go(50),$('form[target="dummy_frame"], iframe[name="dummy_frame"]').remove(),$("<iframe>").hide().attr("name","dummy_frame").appendTo("body").one("load",function(){$("html",m).attr("class",this.contentWindow.document.documentElement.className),$("head",m).replaceWith(this.contentWindow.document.head),$("body",m).replaceWith(this.contentWindow.document.body),$('[data-leafpub-id="post:title"]',m).replaceWith(a),$('[data-leafpub-id="post:content"]',m).replaceWith(n),$(this).remove(),E.go(100),t.resolve()}),$(i).hide().attr("action",Leafpub.url("api/posts/render")).attr("method","post").attr("target","dummy_frame").append($('<input type="hidden" name="post-json">').val(JSON.stringify(e))).append('<input type="hidden" name="zen" value="'+(L?"true":"false")+'">').appendTo("body").submit().remove(),t}function s(e){b&&("function"==typeof b[e]&&b[e](),"save"===e&&d(),"zen"===e&&c(),"settings"===e&&a(".settings-panel"),"link"===e&&a(".link-panel"),"embed"===e&&a(".embed-panel"),"image"===e&&a(".image-panel"))}function d(){var e=""===w?"POST":"PUT",t=Leafpub.url("POST"===e?"api/posts":"api/posts/"+encodeURIComponent(w));!y&&D&&(E.go(50),Leafpub.highlightErrors(".settings-form"),y=$.ajax({url:t,type:e,data:{post:w,properties:g()}}).done(function(e){e.success?(D=!1,Leafpub.announce($('meta[name="leafpub:language"]').attr("data-changes-saved"),{style:"success"}).then(function(){window.onbeforeunload=null,location.href=Leafpub.adminUrl("posts")})):(Leafpub.highlightErrors(".settings-form",e.invalid),$.alertable.alert(e.message))}).always(function(){E.go(100),y=null}))}function g(){var e,t=$("#tags").get(0).selectize,a=t.items,n=[];for(e=0;e<t.items.length;e++)n[e]={slug:t.getItem(t.items[e]).attr("data-value"),name:t.getItem(t.items[e]).text()};return{title:v?v.getContent():null,content:b?b.getContent():null,slug:$("#slug").val()||Leafpub.slug(v.getContent()),pub_date:$("#pub-date").val()+" "+$("#pub-time").val(),image:$("#image").val(),tags:a,tag_data:n,author:$("#author").val(),status:$("#status").val(),featured:$("#featured").prop("checked"),sticky:$("#sticky").prop("checked"),page:$("#page").prop("checked"),meta_title:$("#meta-title").val(),meta_description:$("#meta-description").val()}}function u(e){e?($('input[name="image"]').val(e).trigger("change"),$(".post-image").css("background-image",'url("'+Leafpub.url(e)+'")'),$(".remove-post-image").prop("hidden",!1)):($('input[name="image"]').val("").trigger("change"),$(".post-image").css("background-image","none"),$(".remove-post-image").prop("hidden",!0))}function p(e){var t=$(e.target).parents().addBack();$(".dropzone").prop("hidden",!1),$('.dropzone [data-target="post-image"]').toggleClass("active",$(t).is('[data-target="post-image"]')),$('.dropzone [data-target="content"]').toggleClass("active",$(t).is('[data-target="content"]')),clearTimeout(C)}function c(e){L=!!e||!L,$('[data-editor="zen"]').toggleClass("active",L),$(".editor-frame").addClass("fade-out"),Cookies.set("zen",L?"true":"false"),r(g()).then(function(){$(".editor-frame").removeClass("fade-out")})}function f(){var e=$("#slug").val(),t=$.trim($("#meta-title").val())||$.trim(v.getContent()),a=$.trim($("#meta-description").val())||$.trim($(b.getContent()).text());$(".se-slug").text(e),$(".se-title").text(t),$(".se-description").text(a)}function h(){var e="draft"===$("#status").val();$('[data-editor="save"]').toggleClass("btn-primary",!e).toggleClass("btn-warning",e)}var m,v,b,k,C,y,w=$('input[name="post"]').val(),L="true"===Cookies.get("zen"),D=!1,_="true"===$("#tags").attr("data-can-create-tags"),E=new Nanobar;$(".editor-toolbar").find("[title]").tooltip({trigger:"hover",placement:"bottom"}).on("show.bs.tooltip",function(e){"ontouchstart"in document.documentElement&&e.preventDefault()}),window.onbeforeunload=function(){if(D&&k!==JSON.stringify(g()))return $(".editor-frame").attr("data-unsaved-changes")},$(".editor-loader").prop("hidden",!1),$(".editor-frame").one("load",o).attr("src",$(".editor-frame").attr("data-src")),$(".dropdown-btn").on("shown.bs.dropdown",function(){var e=$(this).find(".dropdown-menu");$(e).removeClass("dropdown-menu-right").toggleClass("dropdown-menu-right",$(e).is(":off-right"))}),$(".editor-toolbar").on("mousedown",function(e){e.preventDefault()}),$("#tags").selectize({items:JSON.parse($("#tags").attr("data-post-tags")),options:JSON.parse($("#tags").attr("data-all-tags")),valueField:"slug",labelField:"name",delimiter:",",highlight:!1,createOnBlur:!0,persist:!1,searchField:["slug","name"],create:!!_&&function(e){var t=Leafpub.slug(e);return!!t.length&&{slug:t,name:e}},render:{option_create:function(e,t){return'<div class="create"><i class="fa fa-plus-circle"></i> '+t(e.input)+"</div>"}}}),$("#slug").on("change",function(){this.value=Leafpub.slug(this.value)}),$(".upload-post-image").on("change",'input[type="file"]',function(e){var t=this;e.target.files.length&&Leafpub.upload({accept:"image",files:e.target.files[0],progress:function(e){E.go(e)}}).then(function(e){$(t).replaceWith($(t).clone()),e.uploaded.length&&u(e.uploaded[0].relative_path),e.failed.length&&$.alertable.alert(e.failed[0].message)})}),$(".remove-post-image").on("click",function(){u(null)}),$("#status").on("change",function(){h()}),$("[data-view-history]").on("click",function(){window.open($(this).attr("data-url"))}),$("[data-restore-history]").on("click",function(){function e(){E.go(50),$.ajax({url:Leafpub.url("api/history/"+encodeURIComponent(a)),type:"GET"}).done(function(e){e.success&&t(e.history.post_data)}).always(function(){E.go(100)})}var a=$(this).attr("data-restore-history"),n=$(".editor-frame").attr("data-unsaved-changes");k!==JSON.stringify(g())?$.alertable.confirm(n).then(e):e()}),$("[data-delete-history]").on("click",function(){var e=$(this).attr("data-delete-history"),t=$(this).attr("data-confirm"),a=$(this).closest("tr");$.alertable.confirm(t).then(function(){E.go(50),$.ajax({url:Leafpub.url("api/history/"+encodeURIComponent(e)),type:"DELETE"}).done(function(e){e.success&&$(a).remove()}).always(function(){E.go(100)})})}),$("[data-editor]").on("click",function(){s($(this).attr("data-editor"))}),$(document).on("keydown",function(e){var t=e.metaKey||e.ctrlKey;t&&188===e.keyCode&&(e.preventDefault(),a(".settings-panel")),t&&75===e.keyCode&&(e.preventDefault(),a(".link-panel")),t&&e.shiftKey&&73===e.keyCode&&(e.preventDefault(),a(".image-panel")),t&&e.shiftKey&&69===e.keyCode&&(e.preventDefault(),a(".embed-panel")),t&&83===e.keyCode&&(e.preventDefault(),d()),t&&190===e.keyCode&&(e.preventDefault(),c())}),function(){var e=$('[data-editor="settings"]');$(".settings-panel").on("show.leafpub.panel",function(){f(),$(e).addClass("active")}).on("hide.leafpub.panel",function(){$(e).removeClass("active")}),$(".settings-panel :input").on("change",function(){r(g())}),$("#slug, #meta-title, #meta-description").on("change keyup paste",f)}(),function(){var e,t,a=$('[data-editor="link"]');$(".link-panel").on("show.leafpub.panel",function(){var n,i,o,l;e=b.getBookmark(),t=$(b.getSelectedElement()).closest("a"),n=decodeURI($(t).attr("href")||""),i=$(t).attr("title")||"",o=$(t).attr("class")||"",l=$(t).attr("target")||"",$("#link-href").val(n),$("#link-title").val(i),$("#link-class").val(o),$("#link-new-window").prop("checked","_blank"===l),$(".link-open").prop("hidden",0===n.length),$(".unlink").prop("hidden",!t.length),$(a).addClass("active")}).on("shown.leafpub.panel",function(){$("#link-href").focus()}).on("hide.leafpub.panel",function(){$(a).removeClass("active"),b.focus()}),$(".link-form").on("submit",function(t){var a=encodeURI($("#link-href").val()),n=$("#link-title").val(),i=$("#link-class").val(),o=$("#link-new-window").prop("checked")?"_blank":"";t.preventDefault(),b.restoreBookmark(e),a.length?b.link("insert",{href:a,title:n,"class":i,target:o}):b.link("remove")}),$(".unlink").on("click",function(){b.link("remove"),n(".link-panel")}),$(".upload-file").on("change",'input[type="file"]',function(e){var t=this;e.target.files.length&&Leafpub.upload({files:e.target.files[0],progress:function(e){E.go(e)}}).then(function(e){$(t).replaceWith($(t).clone()),e.uploaded.length&&e.uploaded.length&&$("#link-href").val(e.uploaded[0].relative_path).trigger("change"),e.failed.length&&$.alertable.alert(e.failed[0].message)})})}(),function(){var e,t,a,i,o=$('[data-editor="image"]');$(".image-panel").on("show.leafpub.panel",function(){var n,l,r;e=b.getBookmark(),t=$(b.getSelectedElement()).closest("img"),n=decodeURI($(t).attr("src")||""),l=decodeURI($(t).parent().is("a")?$(t).parent().attr("href"):""),r=$(t).attr("alt")||"",a=$(t).attr("width")||null,i=$(t).attr("height")||null,$(".image-align-none").trigger("click"),t&&(b.alignLeft("test")&&$(".image-align-left").trigger("click"),b.alignCenter("test")&&$(".image-align-center").trigger("click"),b.alignRight("test")&&$(".image-align-right").trigger("click")),$("#image-src").val(n),$("#image-href").val(l),$("#image-alt").val(r),$("#image-width").val(a),$("#image-height").val(i),$("#image-constrain").prop("checked",!0),$(".image-open").prop("hidden",0===l.length),$(".delete-image").prop("hidden",!t.length),$(o).addClass("active")}).on("shown.leafpub.panel",function(){$("#image-src").focus()}).on("hide.leafpub.panel",function(){$(o).removeClass("active"),b.focus()}),$(".image-form").on("submit",function(t){var a=encodeURI($("#image-src").val()),n=encodeURI($("#image-href").val()),i=$("#image-alt").val(),o=$("#image-width").val(),l=$("#image-height").val(),r=$(".image-form").find('input[name="align"]:checked').val();t.preventDefault(),b.restoreBookmark(e),a.length?b.image("insert",{src:a,href:n,alt:i,width:o,height:l,align:r}):b.image("remove")}),$(".delete-image").on("click",function(){b.image("remove"),n(".image-panel")}),$(".upload-image").on("change",'input[type="file"]',function(e){var t=this;e.target.files.length&&Leafpub.upload({accept:"image",files:e.target.files[0],progress:function(e){E.go(e)}}).then(function(e){$(t).replaceWith($(t).clone()),e.uploaded.length&&e.uploaded.length&&$("#image-src").val(e.uploaded[0].relative_path).trigger("change"),e.failed.length&&$.alertable.alert(e.failed[0].message)})}),$("#image-src").on("change",function(){var e,t=$(this).val();t.length&&(t=Leafpub.url(t),e=$("<img>").hide().one("load",function(){a=this.naturalWidth,i=this.naturalHeight,$("#image-width").val(a),$("#image-height").val(i),$(e).remove()}).on("error",function(){$(e).remove()}).appendTo("body").attr("src",t))}),$("#image-width, #image-height").on("change",function(){var e=$("#image-width").val(),t=$("#image-height").val(),n=$("#image-constrain").prop("checked");n&&e&&t&&a&&i&&(parseInt(a)!==parseInt(e)?(t=Math.round(e/a*t),isNaN(t)||$("#image-height").val(t)):(e=Math.round(t/i*e),isNaN(e)||$("#image-width").val(e))),a=e,i=t})}(),function(){var e,t,a=$('[data-editor="embed"]');$(".embed-panel").on("show.leafpub.panel",function(){var n;e=b.getBookmark(),t=$(b.getSelectedElement()).closest("[data-embed]"),n=$(t).attr("data-embed")||"",$(".embed-align-none").trigger("click"),t&&(b.alignLeft("test")&&$(".embed-align-left").trigger("click"),b.alignCenter("test")&&$(".embed-align-center").trigger("click"),b.alignRight("test")&&$(".embed-align-right").trigger("click")),$("#embed-code").val(n),$(".delete-embed").prop("hidden",!t.length),$(a).addClass("active")}).on("shown.leafpub.panel",function(){$("#embed-code").focus()}).on("hide.leafpub.panel",function(){$(a).removeClass("active"),b.focus()}),$(".embed-form").on("submit",function(t){var a=$("#embed-code").val(),n=$(".embed-form").find('input[name="align"]:checked').val();t.preventDefault(),b.restoreBookmark(e),a.length?a.match(/^https?:\/\//i)?(E.go(50),$.ajax({url:Leafpub.url("api/oembed"),type:"GET",data:{url:a}}).done(function(e){e.code?b.embed("insert",{code:e.code}):b.insertContent(a)}).always(function(){E.go(100)})):b.embed("insert",{code:a,align:n}):b.embed("remove")}),$(".delete-embed").on("click",function(){b.embed("remove"),n(".embed-panel")})}()});