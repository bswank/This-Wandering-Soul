/* globals Nanobar, Leafpub */
$(function(){"use strict";function e(){var e=$("#slug").val(),a=$.trim($("#meta-title").val())||$.trim($("#name").val()),t=$.trim($("#meta-description").val())||$.trim($(Leafpub.markdownToHtml($("#description").val())).text());$(".se-slug").text(e),$(".se-title").text(a),$(".se-description").text(t)}var a,t=new Nanobar,n=$('input[name="tag"]').val();$(".tag-form").on("submit",function(e){var i=this,o=""===n?"POST":"PUT",l=Leafpub.url("POST"===o?"api/tags":"api/tags/"+encodeURIComponent(n));e.preventDefault(),a||(t.go(50),Leafpub.highlightErrors(i),a=$.ajax({url:l,type:o,data:$(this).serialize()}).done(function(e){e.success?($(i).off("submit").on("submit",function(e){e.preventDefault()}),Leafpub.announce($('meta[name="leafpub:language"]').attr("data-changes-saved"),{style:"success"}).then(function(){location.href=Leafpub.adminUrl("tags")})):(Leafpub.highlightErrors(i,e.invalid),$.alertable.alert(e.message))}).always(function(){a=null,t.go(100)}))}),$(".open").on("click",function(){window.open($(this).attr("data-url"))}),$(".delete").on("click",function(){var e=$(this).attr("data-confirm");$.alertable.confirm(e).then(function(){t.go(50),$.ajax({url:Leafpub.url("api/tags/"+encodeURIComponent(n)),type:"DELETE"}).done(function(e){e.success?location.href=Leafpub.adminUrl("tags"):$.alertable.alert(e.message)}).always(function(){t.go(100)})})}),$(".submit").on("click",function(){$(".tag-form").submit()}),$("#slug").on("change",function(){this.value=Leafpub.slug(this.value)}),$("#name").on("change",function(){var e=Leafpub.slug(this.value);""===$("#slug").val()&&$("#slug").val(e)}),$("#name").on("change keyup paste",function(){$(".cover-name").text(this.value)}),$("#name, #description, #slug, #meta-title, #meta-description").on("change keyup paste",e),e(),$(".upload-cover").on("change",'input[type="file"]',function(e){var a=this;e.target.files.length&&Leafpub.upload({accept:"image",files:e.target.files[0],progress:function(e){t.go(e)}}).then(function(e){$(a).replaceWith($(a).clone()),e.uploaded.length&&($('input[name="cover"]').val(e.uploaded[0].relative_path),$(".cover").css("background-image",'url("'+e.uploaded[0].url+'")'),$(".remove-cover").prop("hidden",!1)),e.failed.length&&$.alertable.alert(e.failed[0].message)})}),$(".remove-cover").on("click",function(){$('input[name="cover"]').val(""),$(".cover").css("background-image","none"),$(".remove-cover").prop("hidden",!0)})});